# SAVAM AI working notes

- Runtime: Express 5 + TypeScript (ESM) API. Entry is [src/server/index.ts](src/server/index.ts) booting [src/app.ts](src/app.ts) with security middleware (helmet, cors, rate limiting), JSON/urlencoded parsers, morgan logging, health routes without `/api`, and the main router mounted at `/api`.
- Env: [src/config/env.ts](src/config/env.ts) loads `.env` via `process.loadEnvFile()`, builds `config`, and validates required vars in production. Defaults exist for `PORT` (3000) and `MONGO_URL` (mongodb://127.0.0.1:27017/savam). JWT defaults are insecure; set `JWT_SECRET`/`JWT_REFRESH_SECRET` in real deployments.
- DB: [src/config/index.ts](src/config/index.ts) connects to MongoDB with mongoose, logs warnings if `MONGO_URL` missing, and exits on failure. Graceful shutdown closes HTTP + Mongo in [src/server/gracefulShutdown.ts](src/server/gracefulShutdown.ts).
- API layering pattern (repeat it for new features): Router wires controller -> service -> repository -> mongoose model. Types live in `src/types`. See the Usuarios stack: router [src/routes/UsuariosRouter.ts](src/routes/UsuariosRouter.ts), controller [src/controllers/UsuarioController.ts](src/controllers/UsuarioController.ts), service [src/services/UsuarioServices.ts](src/services/UsuarioServices.ts), repository [src/repositories/UsuariosRepository.ts](src/repositories/UsuariosRepository.ts), model [src/models/Usuarios.ts](src/models/Usuarios.ts).
- Other stacks mirror the same shape: Roles, Numeros, Suscriptor. Follow this dependency injection style: instantiate repository/service/controller in the router file and export a function that registers routes on the shared Router instance from [src/routes/index.ts](src/routes/index.ts).
- Authentication: [src/routes/AuthenticationRouter.ts](src/routes/AuthenticationRouter.ts) exposes `POST /api/login`. Controller [src/controllers/AuthenticationController.ts](src/controllers/AuthenticationController.ts) lowercases input keys to match mobile clients, calls service [src/services/AuthenticationServices.ts](src/services/AuthenticationServices.ts) which checks passwords with bcrypt and issues JWTs. It currently reads `process.env.JWT_SECRET` directly; align with `config.jwt.secret` if you add new auth paths. Auth middleware exists in [src/middleware/auth.ts](src/middleware/auth.ts) but is not yet applied to routers—attach it when securing endpoints.
- Security middleware: CORS rules in [src/config/cors.ts](src/config/cors.ts) (allow all in dev, whitelist in prod), Helmet config in [src/config/security.ts](src/config/security.ts), rate limiters in [src/config/rateLimit.ts](src/config/rateLimit.ts) (general limiter enabled globally). Error handling is centralized in [src/middleware/errorHandler.ts](src/middleware/errorHandler.ts); keep it last in the middleware chain.
- Health endpoints: `/health`, `/health/full`, `/ready`, `/live` from [src/server/healthCheck.ts](src/server/healthCheck.ts). These sit outside `/api` and are useful for probes.
- Models/collections: usuarios, roles, numeros, suscriptor live in `src/models/*`. Seeder example data is in [src/config/seederdb.bson](src/config/seederdb.bson) (roles, default users with hashed bcrypt expected, phone numbers, suscriptor records).
- Path aliases: `@/` resolves to `src` (see [tsconfig.json](tsconfig.json)). Use absolute imports with this alias; `tsc-alias` fixes paths on build.
- Scripts: `npm run dev` (tsx watch src/server/index.ts), `npm run build` (tsc + tsc-alias), `npm start` (node dist/server/index.js), `npm run clean` (rm -rf dist). No test runner is configured; `test/` is currently empty.
- Conventions: Spanish naming; responses are plain JSON with simple status codes (201 create, 404 when entity missing, generic 500 on errors). Repositories often use `.lean()` and map mongoose documents to plain objects, especially for ID/roles normalization—mirror that when adding fields.
- Passwords: Usuario repository hashes incoming passwords with bcrypt before saving; authentication compares with bcrypt sync. Keep hashing in repositories/services rather than controllers.
- When adding routes, remember they are mounted under `/api` via the shared router. Register new routers in [src/routes/index.ts](src/routes/index.ts) and preserve the same DI pattern.
- Logging: morgan `dev` is enabled globally; optional request logger exists in [src/middleware/requestLogger.ts](src/middleware/requestLogger.ts) but is not wired by default.
- Error messages are user-facing Spanish; keep consistency. Avoid throwing raw errors from controllers—return structured JSON like existing handlers.
